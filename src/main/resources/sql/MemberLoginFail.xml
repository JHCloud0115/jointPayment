<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- src/main/resources/mapper/memberMapper.xml -->
<mapper namespace="org.example.mapper.member.MemberLoginFailMapper">


    <select id="selectMemberLoginFailCnt" resultType="org.example.model.response.member.MemberLoginFailResp">
        SELECT
            m.email,
            m.login_fail_uid,
            m.ip,
            m.try_count,
            m.edited_at,
            COALESCE(MAX(m.try_count) + 1, 1) AS fail_cnt
        FROM
            member_login_fail m
        LEFT JOIN
            member mlf ON m.email = mlf.email
        WHERE
            mlf.email =#{email}
        GROUP BY
            m.email, m.login_fail_uid, m.ip, m.try_count, m.edited_at;
    </select>

    <insert id="insertLoginFail"  parameterType="org.example.model.member.LoginFail" useGeneratedKeys="true" >
        INSERT INTO member_login_fail (
                                      email
                                     ,ip
                                     ,try_count
                                     ,edited_at
        ) SELECT
                 #{email}
               , #{ip}
               , COALESCE(MAX(try_count) + 1, 1)
               , now()
        FROM
            member_login_fail
        WHERE
            email = #{email}
    </insert>

    <update id="updateLoginFailCount" >
        UPDATE
            member_login_fail
        SET
            try_count = #{tryCount}
        WHERE
            email = #{email}
    </update>

</mapper>
